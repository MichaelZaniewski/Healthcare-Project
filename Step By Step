Everything Ive done:
Aggregated a LOS column

ALTER TABLE visits
ADD COLUMN los INT GENERATED ALWAYS AS (
    GREATEST((date_of_discharge::date - date_of_admission::date), 0)
) STORED;

easy join
FROM patient p JOIN billing b ON p.id = b.patient_id JOIN visit v ON b.visit_id = v.visit_id

Exploratory Analysis:
1) Frequency of LOS 
------------
SELECT los, COUNT(*)
FROM visit
GROUP BY los
ORDER BY los ASC
-------------
2) Frequency of conditions (and distinct conditions)

3) Frequency of followups
SELECT 
condition, count(follow_up_required) as Followups
FROM visit
WHERE follow_up_required = 'Y' 
GROUP BY condition
ORDER BY followups DESC 

4) Frequency by condition
SELECT condition, COUNT(visit_id) AS visits_for
FROM visit
GROUP BY condition
ORDER BY visits_for DESC

5) Total late payments where insurance_provider IS NOT NULL (92836)
SELECT SUM(late_paid + late_unpaid)
FROM (SELECT COUNT(*) FILTER(WHERE payment_status = 'Late-Paid') AS late_paid,
COUNT(*) FILTER(WHERE payment_status = 'Late-Unpaid') as late_unpaid
FROM billing b JOIN patient p ON b.patient_id = p.id
WHERE insurance_provider IS NOT NULL)

6) most common insurance providers

SELECT insurance_provider, COUNT(*) AS count
FROM patient
WHERE insurance_provider IS NOT NULL
GROUP BY insurance_provider
ORDER BY count DESC



-------
For the hospital with the highest patient volume, find the percentage of patients discharged on the same day, after one night, and after multi nights. How do these percentages compare to the rest of the dataset? (CTE's)

WITH Lewis_Inc_Hospital AS (SELECT 'Lewis Inc Hospital' AS scope,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los = 0) / COUNT(*)::NUMERIC),2),'999D99%') AS sameday,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los = 1) / COUNT(*)::NUMERIC),2),'999D99%') AS one_night,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los > 1) / COUNT(*)::NUMERIC),2),'999D99%') AS multi_night
FROM visit
WHERE hospital = 'Lewis Inc Hospital'),

National AS (SELECT 'Nationally' AS scope,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los = 0) / COUNT(*)::NUMERIC),2),'999D99%') AS sameday,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los = 1) / COUNT(*)::NUMERIC),2),'999D99%') AS one_night,
TO_CHAR(ROUND(100*(COUNT(*) FILTER(WHERE los > 1) / COUNT(*)::NUMERIC),2),'999D99%') AS multi_night
FROM visit)

SELECT scope, sameday, one_night, multi_night
FROM Lewis_Inc_Hospital
UNION
SELECT scope, sameday, one_night, multi_night
FROM National
------------




-- What is the top insurance provider in the top 5 hospitals IN PROGRESS
SELECT * 
FROM
(SELECT *, 
ROW_NUMBER () OVER (PARTITION BY hospital ORDER BY insurance_patient_count DESC) as provider_rank
FROM (SELECT hospital, insurance_provider, COUNT(DISTINCT p.id) as insurance_patient_count
FROM visit v JOIN patient p ON v.patient_id=p.id 
WHERE insurance_provider IS NOT NULL 
and hospital IN (SELECT hospital
				FROM visit
				GROUP BY hospital
				ORDER BY COUNT(*) DESC
				LIMIT 5)
GROUP BY hospital, insurance_provider
ORDER BY insurance_patient_count DESC)
)
WHERE provider_rank = 1



